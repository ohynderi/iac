---
- set_fact:
    aci_cred: &aci_login
      host: "{{ inventory_hostname }}"
      username: "{{ username }}"
      password: "{{ password }}"
      use_proxy: no
      use_ssl: yes
      validate_certs: no
      annotation: orchestrator:ansible
  no_log: true

- cisco.aci.aci_ap:
    <<: *aci_login
    tenant: "{{ tenant_vars.name }}"
    ap: "{{ ap_vars.name }}"
    state: "{{ ap_vars.state | default('present') }}"
  delegate_to: localhost

- cisco.aci.aci_epg:
    <<: *aci_login
    tenant: "{{ tenant_vars.name }}"
    ap: "{{ ap_vars.name }}"
    epg: "{{ item.name }}"
    bd: "{{ item.bd }}"
    state: "{{ item.state | default('present') }}"
  loop: "{{ ap_vars.epgs | default( [] ) }}"
  loop_control:
    label: "{{ [ tenant_vars.name, item.name ] | join('/') }}"
  delegate_to: localhost

- cisco.aci.aci_epg_to_domain:
    <<: *aci_login
    tenant: "{{ tenant_vars.name }}"
    ap: "{{ ap_vars.name }}"
    epg: "{{ item.name }}"
    domain: "{{ item.domain | default( [] ) }}"
    domain_type: phys
  loop: "{{ ap_vars.epgs }}"
  loop_control:
    label: "{{ [ tenant_vars.name, item.name, item.domain ] | join('/') }}"
  delegate_to: localhost

- cisco.aci.aci_static_binding_to_epg:
    <<: *aci_login
    tenant: "{{ tenant_vars.name }}"
    ap: "{{  ap_vars.name }}"
    epg: "{{ item.0.name }}"
    encap_id: "{{ item.1.vlan }}"
    deploy_immediacy: "lazy"
    interface_mode: "{{ item.1.mode }}"
    interface_type: "{{ intf_pg_map[ item.1.name ] }}"
    pod_id: "1"
    leafs: "{{ intf_to_leaf_map[ item.1.name ][ 'leaf' ] if intf_pg_map[ item.1.name ] != 'vpc' else leaf_to_vpc_domain_map[ intf_to_leaf_map[ item.1.name ]['leaf'] ] }}"
    interface: "{{ intf_to_leaf_map[ item.1.name ][ 'port' ] if intf_pg_map[ item.1.name ] == 'access' else item.1.name }}"
    state: "{{ item.1.state | default('present') }}"
  loop: "{{ query('subelements', ap_vars.epgs, 'interfaces') }}"
  loop_control:
    label: "{{ [ tenant_vars.name, item.0.name, item.1.name ] | join('/') }}"
  delegate_to: localhost
