---
- set_fact:
    aci_cred: &aci_login
      host: "{{ inventory_hostname }}"
      username: "{{ username }}"
      password: "{{ password }}"
      use_proxy: no
      use_ssl: yes
      validate_certs: no
      annotation: orchestrator:ansible
  no_log: true

- name: "'{{ tenant_vars.name }}'/'{{ l3out_vars.name }}'"
  cisco.aci.aci_l3out:
    <<: *aci_login
    tenant: "{{ tenant_vars.name }}"
    vrf: "{{ vrf_vars.name }}"
    name: "{{ l3out_vars.name }}"
    domain: "{{ l3out_vars.domain }}"
    route_control: "{{ l3out_vars.route_control }}"
    l3protocol: "{{ l3out_vars.proto }}"
    state: "{{ l3out_vars.state }}"
  delegate_to: localhost

- name: "'{{ tenant_vars.name }}'/'{{ l3out_vars.name }}'/'{{ node_prof_vars.name }}'"
  cisco.aci.aci_l3out_logical_node_profile:
    <<: *aci_login
    tenant: "{{ tenant_vars.name }}"
    l3out: "{{ l3out_vars.name }}"
    node_profile: "{{ node_prof_vars.name }}"
    state: "{{ node_prof_vars.state }}"
  loop: "{{ l3out_vars.node_profiles | default( [] ) }}"
  loop_control:
    loop_var: node_prof_vars
    label: "{{ [ tenant_vars.name, l3out_vars.name, node_prof_vars.name ] | join('/') }}"
  delegate_to: localhost

- name: "'{{ tenant_vars.name }}'/'{{ l3out_vars.name }}'/'{{ node_prof_vars.name }}'/'{{ node_vars.node_id }}'"
  cisco.aci.aci_l3out_logical_node:
    <<: *aci_login
    tenant: "{{ tenant_vars.name }}"
    l3out: "{{ l3out_vars.name }}"
    node_profile: "{{ node_prof_vars.name }}"
    pod_id: "{{ node_vars.pod_id }}"
    node_id: "{{ node_vars.node_id }}"
    router_id: "{{ node_vars.router_id }}"
    router_id_as_loopback: "{{ node_vars.router_id_as_loopback }}"
    state: "{{ node_vars.state }}"
  loop: "{{ ( l3out_vars.node_profiles | default( [] )) | subelements('nodes', skip_missing=True) }}"
  loop_control:
    loop_var: node_loop_element
    label: "{{ [ tenant_vars.name, node_prof_vars.name, node_vars.node_id ] | join('/') }}"
  vars:
    node_prof_vars: "{{ node_loop_element.0 }}"
    node_vars: "{{ node_loop_element.1 }}"
  delegate_to: localhost

- name: Import L3Out Interface Profile Tasks
  include_tasks: l3out_interface_profile.yml
  loop: "{{ ( l3out_vars.node_profiles | default( [] )) | subelements('interface_profiles', skip_missing=True) }}"
  loop_control:
    loop_var: node_loop_element
    label: "{{ [ tenant_vars.name, node_prof_vars.name, intf_prof_vars.name ] | join('/') }}"
  vars:
    node_prof_vars: "{{ node_loop_element.0 }}"
    intf_prof_vars: "{{ node_loop_element.1 }}"
